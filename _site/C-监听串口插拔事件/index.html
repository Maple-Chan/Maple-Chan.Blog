<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> <title>C# 监听串口插拔事件 &#8211; Maple Story</title> <meta name="description" content="不断强化自己的开发技能"> <meta name="keywords" content="串口通讯, C#"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="halve.png"> <meta name="twitter:title" content="C# 监听串口插拔事件"> <meta name="twitter:description" content="不断强化自己的开发技能"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="C# 监听串口插拔事件"> <meta property="og:description" content="不断强化自己的开发技能"> <meta property="og:url" content="https://www.maplestory.work/C-%E7%9B%91%E5%90%AC%E4%B8%B2%E5%8F%A3%E6%8F%92%E6%8B%94%E4%BA%8B%E4%BB%B6/"> <meta property="og:site_name" content="Maple Story"> <meta property="og:image" content="https://www.maplestory.work/images/halve.png"> <link rel="canonical" href="https://www.maplestory.work/C-%E7%9B%91%E5%90%AC%E4%B8%B2%E5%8F%A3%E6%8F%92%E6%8B%94%E4%BA%8B%E4%BB%B6/"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Feed --> <link type="application/atom+xml" rel="alternate" href="https://www.maplestory.work/feed.xml" title="" /> <!-- Favicons --> <link rel="shortcut icon" type="image/png" href="https://www.maplestory.work/favicon.png" /> <link rel="shortcut icon" href="https://www.maplestory.work/favicon.ico" /> <!-- CSS --> <link rel="stylesheet" type="text/css" href="https://www.maplestory.work/assets/css/main.css"> <!-- Left Block Image for Posts --> <style type="text/css"> #posts.inner-post-page .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(https://www.maplestory.work/images/unsplash-gallery-image-3.jpg) no-repeat;background-size: cover;} </style> <!-- Left Block Images for Home and Pages --> <style type="text/css"> #posts .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(https://www.maplestory.work/images/unsplash-image-10.jpg) no-repeat;background-size: cover, cover;} .block-left {background: linear-gradient(rgba(44,45,51,0.9), rgba(44,45,51,0.9)), url(https://www.maplestory.work/images/home.jpg) no-repeat;background-size: cover;} </style> </head> <body id="posts" class="inner-post-page"> <div class="block-left"> <div class="content"> <a href="https://www.maplestory.work" class="logo"><img src="https://www.maplestory.work/images/halve.png"></a> <div class="post-title-section"> <div class="section-line">Posts <em>/</em></div> <h1 class="section-title">C# 监听串口插拔事件 </h1> <ul class="tags"> <li><a href="https://www.maplestory.work/tags#串口通讯">串口通讯</a></li> <li><a href="https://www.maplestory.work/tags#C#">C#</a></li> </ul> <div class="section-line reverse"><a href="https://www.maplestory.work/posts">Back to posts</a> <em>/</em></div> </div> </div> </div> <div class="block-right"> <a href="../posts.html" title="posts" class="posts-menu-icon"></a> <a title="projects" class="projects-menu-icon"> <span></span> </a> <div class="inner-post content"> <div class="date-highlight">30 May 2019</div> <center><h2><b> C# 监听串口插拔事件 </b></h2></center> <p><br /></p> <h3 id="section">场景简述</h3> <p>​ 在进行C#串口开发时，往往需要对可访问的串口通过ComboList组件进行呈现共用户进行选择软件需要连接的串口，在这过程中就需要对串口的插拔事件进行监听。当事件到来对列表、串口开关进行对应的变化。使得整个软件操作起来更加合理。</p> <h3 id="section-1">方法介绍</h3> <ol> <li> <p>在WPF中，每一个窗口都拥有一个Loaded事件传入接口，可以将函数传入该接口（即把函数委托给Loaded事件）。Loaded事件在元素即将要被渲染时触发。</p> </li> <li> <p>在Loaded时定义拦截Windows消息拦截事件。事件函数（DeviceChanged）被委托给HwndSource的Hook。</p> </li> <li> <p>在DeviceChanged函数中过滤串口插拔事件，并执行串口插拔后需要完善的逻辑操作。</p> <ol> <li>事件序号：0x219 移动设备改变事件。0x8000设备插入事件。0x8004设备拔出事件。</li> </ol> </li> </ol> <h3 id="section-2">具体实现</h3> <div class="highlighter-rouge"><pre class="highlight"><code><span class="p">&gt;</span> 
<span class="p">&gt;</span> <span class="k">public</span> <span class="nf">MainWindow</span><span class="p">()</span>
<span class="p">&gt;</span> <span class="p">{</span>
<span class="p">&gt;</span>     <span class="n">Loaded</span><span class="p">+=</span><span class="n">MainWindow_Loaded</span><span class="p">;</span>
<span class="p">&gt;</span> <span class="p">}</span>
<span class="p">&gt;</span> 
<span class="p">&gt;</span> <span class="k">void</span> <span class="nf">MainWindow_Loaded</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span><span class="n">RoutedEventArgs</span> <span class="n">e</span><span class="p">)</span>
<span class="p">&gt;</span> <span class="p">{</span>
<span class="p">&gt;</span>     <span class="n">HwndSource</span> <span class="n">hwndSource</span> <span class="p">=</span> <span class="n">PresentationSource</span><span class="p">.</span><span class="nf">FromVisual</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="k">as</span> <span class="n">HwndSource</span><span class="p">;</span>
<span class="p">&gt;</span>     <span class="k">if</span><span class="p">(</span><span class="k">null</span><span class="p">!=</span><span class="n">hwndSource</span><span class="p">)</span>
<span class="p">&gt;</span>     	<span class="n">hwndSource</span><span class="p">.</span><span class="nf">AddHook</span><span class="p">(</span><span class="k">new</span> <span class="nf">HwndSourceHook</span><span class="p">(</span><span class="n">DevieceChanged</span><span class="p">));</span>
<span class="p">&gt;</span> <span class="p">}</span>
<span class="p">&gt;</span> 
<span class="p">&gt;</span> <span class="k">private</span> <span class="n">IntPtr</span> <span class="nf">DeviceChanged</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">hwnd</span><span class="p">,</span><span class="kt">int</span> <span class="n">msg</span><span class="p">,</span><span class="n">IntPtr</span> <span class="n">wParam</span><span class="p">,</span><span class="n">IntPtr</span> <span class="n">lParam</span><span class="p">,</span><span class="k">ref</span> <span class="kt">bool</span> <span class="n">handled</span><span class="p">)</span>
<span class="p">&gt;</span> <span class="p">{</span>
<span class="p">&gt;</span>     <span class="kt">string</span><span class="p">[]</span> <span class="n">PortNames</span><span class="p">;</span>
<span class="p">&gt;</span>     <span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="p">==</span> <span class="n">WM_DEVICECHANGE</span><span class="p">)</span>
<span class="p">&gt;</span>     <span class="p">{</span>
<span class="p">&gt;</span>         <span class="k">switch</span> <span class="p">(</span><span class="n">wParam</span><span class="p">.</span><span class="nf">ToInt32</span><span class="p">())</span>
<span class="p">&gt;</span>         <span class="p">{</span>
<span class="p">&gt;</span>             <span class="k">case</span> <span class="n">DBT_DEVICEARRIVAL</span><span class="p">:</span><span class="c1">//设备插入  
</span><span class="p">&gt;</span>                 <span class="n">PortNames</span> <span class="p">=</span> <span class="n">SerialPort</span><span class="p">.</span><span class="nf">GetPortNames</span><span class="p">();</span>
<span class="p">&gt;</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">IsWorking</span> <span class="p">==</span> <span class="k">true</span> <span class="p">&amp;&amp;</span> <span class="n">PortNames</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">ConfigInfo</span><span class="p">.</span><span class="n">Port</span><span class="p">))</span>
<span class="p">&gt;</span>                 <span class="p">{</span>
<span class="p">&gt;</span>                     <span class="k">if</span> <span class="p">(</span><span class="n">serialPortUtil</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">&gt;</span>                     <span class="p">{</span>
<span class="p">&gt;</span>                         <span class="n">serialPortUtil</span><span class="p">.</span><span class="nf">OpenPort</span><span class="p">();</span>
<span class="p">&gt;</span>                         <span class="n">MsgBox</span><span class="p">.</span><span class="nf">Show</span><span class="p">(</span><span class="s">"串口连接成功！"</span><span class="p">);</span>
<span class="p">&gt;</span>                     <span class="p">}</span>
<span class="p">&gt;</span>                 <span class="p">}</span>
<span class="p">&gt;</span>                 <span class="k">break</span><span class="p">;</span>
<span class="p">&gt;</span>             <span class="k">case</span> <span class="n">DBT_DEVICEREMOVECOMPLETE</span><span class="p">:</span> <span class="c1">//设备卸载
</span><span class="p">&gt;</span>                 <span class="n">PortNames</span> <span class="p">=</span> <span class="n">SerialPort</span><span class="p">.</span><span class="nf">GetPortNames</span><span class="p">();</span>  
<span class="p">&gt;</span>                 <span class="k">if</span> <span class="p">(</span><span class="n">IsWorking</span> <span class="p">==</span> <span class="k">true</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">PortNames</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">ConfigInfo</span><span class="p">.</span><span class="n">Port</span><span class="p">))</span>
<span class="p">&gt;</span>                 <span class="p">{</span>
<span class="p">&gt;</span>                     <span class="n">MsgBox</span><span class="p">.</span><span class="nf">Show</span><span class="p">(</span><span class="s">"串口连接断开！"</span><span class="p">);</span>
<span class="p">&gt;</span>                 <span class="p">}</span>
<span class="p">&gt;</span>                 <span class="k">break</span><span class="p">;</span>
<span class="p">&gt;</span>             <span class="k">default</span><span class="p">:</span>
<span class="p">&gt;</span>                 <span class="k">break</span><span class="p">;</span>
<span class="p">&gt;</span>         <span class="p">}</span>
<span class="p">&gt;</span>     <span class="p">}</span>
<span class="p">&gt;</span>     <span class="k">return</span> <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">;</span> 
<span class="p">&gt;</span> <span class="p">}</span>
<span class="p">&gt;</span> <span class="err">```</span>
<span class="p">&gt;</span>
<span class="p">&gt;</span> 
</code></pre></div> <p>通过该方法可以实现对串口插拔事件的监听。</p> <p>参考文献</p> <p>​ <a href="https://blog.csdn.net/barry_hui/article/details/80326403">C# WPF USB 串口插入拔出识别监测</a></p> <br> <nav class="pagination"> <a href="https://www.maplestory.work/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="pagination_pager" title="设计模式 ">previous</a> <a href="https://www.maplestory.work/C-%E6%9F%A5%E7%9C%8B%E4%B8%B2%E5%8F%A3/" class="pagination_pager" title="C# 查看串口 ">next</a> </nav> </div> </div> <!-- JS --> <script src="https://www.maplestory.work/assets/js/main.min.js"></script> <div class="overlay"> <ul class="projects-menu"> <li style="background:url(https://www.maplestory.work/images/benjamin-deyoung-unsplash.jpg) center center no-repeat;"> <a href="https://github.com/Maple-Chan" target="_blank" rel="nofollow external"> <span> GitHub Home </span> </a> </li> </ul> </div> </body> </html>
