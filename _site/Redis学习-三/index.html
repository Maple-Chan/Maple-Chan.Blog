<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> <title>Redis学习（三） &#8211; Maple Story</title> <meta name="description" content="Stick to note down what I’v learnt"> <meta name="keywords" content="Java, Back End"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="halve.png"> <meta name="twitter:title" content="Redis学习（三）"> <meta name="twitter:description" content="Stick to note down what I’v learnt"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="Redis学习（三）"> <meta property="og:description" content="Stick to note down what I’v learnt"> <meta property="og:url" content="http://localhost:4000/Redis%E5%AD%A6%E4%B9%A0-%E4%B8%89/"> <meta property="og:site_name" content="Maple Story"> <meta property="og:image" content="http://localhost:4000/images/halve.png"> <link rel="canonical" href="http://localhost:4000/Redis%E5%AD%A6%E4%B9%A0-%E4%B8%89/"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Feed --> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="" /> <!-- Favicons --> <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png" /> <link rel="shortcut icon" href="http://localhost:4000/favicon.ico" /> <!-- CSS --> <link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/main.css"> <!-- Left Block Image for Posts --> <style type="text/css"> #posts.inner-post-page .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(http://localhost:4000/images/unsplash-gallery-image-3.jpg) no-repeat;background-size: cover;} </style> <!-- Left Block Images for Home and Pages --> <style type="text/css"> #posts .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(http://localhost:4000/images/unsplash-image-10.jpg) no-repeat;background-size: cover, cover;} .block-left {background: linear-gradient(rgba(44,45,51,0.9), rgba(44,45,51,0.9)), url(http://localhost:4000/images/home.jpg) no-repeat;background-size: cover;} </style> </head> <body id="posts" class="inner-post-page"> <div class="block-left"> <div class="content"> <a href="http://localhost:4000" class="logo"><img src="http://localhost:4000/images/halve.png"></a> <div class="post-title-section"> <div class="section-line">Posts <em>/</em></div> <h1 class="section-title">Redis学习（三） </h1> <ul class="tags"> <li><a href="http://localhost:4000/tags#Java">Java</a></li> <li><a href="http://localhost:4000/tags#Back End">Back End</a></li> </ul> <div class="section-line reverse"><a href="http://localhost:4000/posts">Back to posts</a> <em>/</em></div> </div> </div> </div> <div class="block-right"> <a href="../posts.html" title="posts" class="posts-menu-icon"></a> <a title="projects" class="projects-menu-icon"> <span></span> </a> <div class="inner-post content"> <div class="date-highlight">18 Aug 2020</div> <center><h1><b>Redis学习（三）</b></h1></center> <p><br /></p> <h2 id="实战二">实战（二）</h2> <p>参考：</p> <blockquote> <p><a href="https://www.cnblogs.com/it-dennis/p/12603142.html">redis in action 学习笔记系列</a></p> <p><a href="http://redisinaction.com/">redis in action</a></p> <p>https://github.com/josiahcarlson/redis-in-action</p> </blockquote> <h3 id="jedis">Jedis</h3> <p>maven项目导入依赖</p> <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- https://mvnrepository.com/artifact/redis.clients/jedis --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>redis.clients<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>jedis<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>3.0.1<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div> <h3 id="发布订阅模式实践">发布订阅模式实践</h3> <p>通过Redis完成两个平台进行消息发布订阅的功能。</p> <p><strong>继承JedisPubSub类重载为自己的订阅方法</strong></p> <p>本例中我们实现一个订阅器<code class="language-plaintext highlighter-rouge">RedisSubscriber</code>，对发布时不进行重载</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.maple.demo_for_springfox.test_for_jedis.service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">redis.clients.jedis.JedisPool</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">redis.clients.jedis.JedisPubSub</span><span class="o">;</span>

<span class="cm">/**
 * @author Chenyufeng
 * @title: RedisSubscriber
 * @projectName demo_for_spring
 * @description: TODO
 * @date 2020/8/18 11:01
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisSubscriber</span> <span class="kd">extends</span> <span class="nc">JedisPubSub</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">subscribe</span><span class="o">(</span><span class="nc">String</span><span class="o">...</span> <span class="n">channels</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">channels</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="c1">// 当发起订阅的时候会执行如下方法</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSubscribe</span><span class="o">(</span><span class="nc">String</span> <span class="n">channel</span><span class="o">,</span> <span class="kt">int</span> <span class="n">subscribedChannels</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onSubscribe</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="n">subscribedChannels</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"订阅消息：频道%s , 频道数 %d"</span><span class="o">,</span> <span class="n">channel</span><span class="o">,</span> <span class="n">subscribedChannels</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="c1">// 当有消息接收的时候会执行如下方法</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="nc">String</span> <span class="n">channel</span><span class="o">,</span> <span class="nc">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onMessage</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"消费消息：频道%s ,消息：%s"</span><span class="o">,</span> <span class="n">channel</span><span class="o">,</span> <span class="n">message</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <h4 id="启用订阅端线程">启用订阅端线程</h4> <p>通过Jedis对象来进行订阅消息的时候，会阻塞等待，因此我们的采用开辟线程的方式来接收消息！</p> <p>关于阻塞之处：<a href="#anchor">Redis接收数据</a></p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="n">jedisPool</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>
<span class="n">jedis</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">redisSubscriber</span><span class="o">,</span> <span class="s">"ADD_ORG"</span><span class="o">);</span>
<span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</code></pre></div></div> <p><strong>接收/订阅端线程</strong></p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">class</span> <span class="nc">mSub</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">JedisPool</span> <span class="n">jedisPool</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">channelRedis</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">RedisSubscriber</span> <span class="n">redisSubscriber</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">mSub</span><span class="o">(</span><span class="nc">JedisPool</span> <span class="n">jedisPool</span><span class="o">,</span> <span class="nc">String</span> <span class="n">channelRedis</span><span class="o">,</span> <span class="nc">RedisSubscriber</span> <span class="n">subscriber</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">jedisPool</span> <span class="o">=</span> <span class="n">jedisPool</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">channelRedis</span> <span class="o">=</span> <span class="n">channelRedis</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">redisSubscriber</span> <span class="o">=</span> <span class="n">subscriber</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">jedis</span> <span class="o">=</span> <span class="n">jedisPool</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>
                <span class="n">jedis</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">redisSubscriber</span><span class="o">,</span> <span class="n">channelRedis</span><span class="o">);</span>

            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"订阅失败！"</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">jedis</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

</code></pre></div></div> <p><strong>消息发布</strong></p> <p>这里需注意，jedis2进行完发布之后需要进行close()，否则会因无法获得资源而阻塞。<a href="#anchor2">RedisPool资源定义</a></p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">JedisPool</span> <span class="n">jedisPool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JedisPool</span><span class="o">(</span><span class="s">"172.18.21.79"</span><span class="o">);</span>

        <span class="nc">RedisSubscriber</span> <span class="n">redisSubscriber</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RedisSubscriber</span><span class="o">();</span>

        <span class="n">mSub</span> <span class="n">sub</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TestJedis</span><span class="o">().</span><span class="na">new</span> <span class="n">mSub</span><span class="o">(</span><span class="n">jedisPool</span><span class="o">,</span> <span class="s">"ADD_ORG"</span><span class="o">,</span> <span class="n">redisSubscriber</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">sub</span><span class="o">);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="nc">Scanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Scanner</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">scanner</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
<span class="c1">//            System.out.println("mSub线程状态：" + thread.getState());</span>
            <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"new Message: "</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>
            
            <span class="nc">Jedis</span> <span class="n">jedis2</span> <span class="o">=</span> <span class="n">jedisPool</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>
            <span class="n">jedis2</span><span class="o">.</span><span class="na">publish</span><span class="o">(</span><span class="s">"ADD_ORG"</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
            <span class="n">jedis2</span><span class="o">.</span><span class="na">close</span><span class="o">();</span> <span class="c1">//不关闭会导致之后无法获得jedis资源。</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div> <h3 id="附录">附录：</h3> <p><a name="anchor"><strong>客户端处理接收消息过程:</strong></a></p> <p>Jedis在订阅数据后客户端的处理流程如下：</p> <p>在<code class="language-plaintext highlighter-rouge"> List&lt;Object&gt; reply = client.getRawObjectMultiBulkReply();</code>语句将会一直等待发布消息的到来。</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="nc">Client</span> <span class="n">client</span><span class="o">)</span> <span class="o">{</span>

    <span class="k">do</span> <span class="o">{</span>
      <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">reply</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">getRawObjectMultiBulkReply</span><span class="o">();</span>
      <span class="kd">final</span> <span class="nc">Object</span> <span class="n">firstObj</span> <span class="o">=</span> <span class="n">reply</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(!(</span><span class="n">firstObj</span> <span class="k">instanceof</span> <span class="kt">byte</span><span class="o">[]))</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">JedisException</span><span class="o">(</span><span class="s">"Unknown message type: "</span> <span class="o">+</span> <span class="n">firstObj</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">resp</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span> <span class="n">firstObj</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="no">SUBSCRIBE</span><span class="o">.</span><span class="na">raw</span><span class="o">,</span> <span class="n">resp</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">subscribedChannels</span> <span class="o">=</span> <span class="o">((</span><span class="nc">Long</span><span class="o">)</span> <span class="n">reply</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">2</span><span class="o">)).</span><span class="na">intValue</span><span class="o">();</span>
        <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">bchannel</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span> <span class="n">reply</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="kd">final</span> <span class="nc">String</span> <span class="n">strchannel</span> <span class="o">=</span> <span class="o">(</span><span class="n">bchannel</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nc">SafeEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">bchannel</span><span class="o">);</span>
        <span class="n">onSubscribe</span><span class="o">(</span><span class="n">strchannel</span><span class="o">,</span> <span class="n">subscribedChannels</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="no">UNSUBSCRIBE</span><span class="o">.</span><span class="na">raw</span><span class="o">,</span> <span class="n">resp</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">subscribedChannels</span> <span class="o">=</span> <span class="o">((</span><span class="nc">Long</span><span class="o">)</span> <span class="n">reply</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">2</span><span class="o">)).</span><span class="na">intValue</span><span class="o">();</span>
        <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">bchannel</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span> <span class="n">reply</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="kd">final</span> <span class="nc">String</span> <span class="n">strchannel</span> <span class="o">=</span> <span class="o">(</span><span class="n">bchannel</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nc">SafeEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">bchannel</span><span class="o">);</span>
        <span class="n">onUnsubscribe</span><span class="o">(</span><span class="n">strchannel</span><span class="o">,</span> <span class="n">subscribedChannels</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="no">MESSAGE</span><span class="o">.</span><span class="na">raw</span><span class="o">,</span> <span class="n">resp</span><span class="o">))</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">bchannel</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span> <span class="n">reply</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">bmesg</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span> <span class="n">reply</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
        <span class="kd">final</span> <span class="nc">String</span> <span class="n">strchannel</span> <span class="o">=</span> <span class="o">(</span><span class="n">bchannel</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nc">SafeEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">bchannel</span><span class="o">);</span>
        <span class="kd">final</span> <span class="nc">String</span> <span class="n">strmesg</span> <span class="o">=</span> <span class="o">(</span><span class="n">bmesg</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nc">SafeEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">bmesg</span><span class="o">);</span>
        <span class="n">onMessage</span><span class="o">(</span><span class="n">strchannel</span><span class="o">,</span> <span class="n">strmesg</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="no">PMESSAGE</span><span class="o">.</span><span class="na">raw</span><span class="o">,</span> <span class="n">resp</span><span class="o">))</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">bpattern</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span> <span class="n">reply</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">bchannel</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span> <span class="n">reply</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
        <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">bmesg</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span> <span class="n">reply</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
        <span class="kd">final</span> <span class="nc">String</span> <span class="n">strpattern</span> <span class="o">=</span> <span class="o">(</span><span class="n">bpattern</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nc">SafeEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">bpattern</span><span class="o">);</span>
        <span class="kd">final</span> <span class="nc">String</span> <span class="n">strchannel</span> <span class="o">=</span> <span class="o">(</span><span class="n">bchannel</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nc">SafeEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">bchannel</span><span class="o">);</span>
        <span class="kd">final</span> <span class="nc">String</span> <span class="n">strmesg</span> <span class="o">=</span> <span class="o">(</span><span class="n">bmesg</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nc">SafeEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">bmesg</span><span class="o">);</span>
        <span class="n">onPMessage</span><span class="o">(</span><span class="n">strpattern</span><span class="o">,</span> <span class="n">strchannel</span><span class="o">,</span> <span class="n">strmesg</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="no">PSUBSCRIBE</span><span class="o">.</span><span class="na">raw</span><span class="o">,</span> <span class="n">resp</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">subscribedChannels</span> <span class="o">=</span> <span class="o">((</span><span class="nc">Long</span><span class="o">)</span> <span class="n">reply</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">2</span><span class="o">)).</span><span class="na">intValue</span><span class="o">();</span>
        <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">bpattern</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span> <span class="n">reply</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="kd">final</span> <span class="nc">String</span> <span class="n">strpattern</span> <span class="o">=</span> <span class="o">(</span><span class="n">bpattern</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nc">SafeEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">bpattern</span><span class="o">);</span>
        <span class="n">onPSubscribe</span><span class="o">(</span><span class="n">strpattern</span><span class="o">,</span> <span class="n">subscribedChannels</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="no">PUNSUBSCRIBE</span><span class="o">.</span><span class="na">raw</span><span class="o">,</span> <span class="n">resp</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">subscribedChannels</span> <span class="o">=</span> <span class="o">((</span><span class="nc">Long</span><span class="o">)</span> <span class="n">reply</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">2</span><span class="o">)).</span><span class="na">intValue</span><span class="o">();</span>
        <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">bpattern</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span> <span class="n">reply</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="kd">final</span> <span class="nc">String</span> <span class="n">strpattern</span> <span class="o">=</span> <span class="o">(</span><span class="n">bpattern</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nc">SafeEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">bpattern</span><span class="o">);</span>
        <span class="n">onPUnsubscribe</span><span class="o">(</span><span class="n">strpattern</span><span class="o">,</span> <span class="n">subscribedChannels</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="no">PONG</span><span class="o">.</span><span class="na">raw</span><span class="o">,</span> <span class="n">resp</span><span class="o">))</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">bpattern</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">[])</span> <span class="n">reply</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="kd">final</span> <span class="nc">String</span> <span class="n">strpattern</span> <span class="o">=</span> <span class="o">(</span><span class="n">bpattern</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nc">SafeEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">bpattern</span><span class="o">);</span>
        <span class="n">onPong</span><span class="o">(</span><span class="n">strpattern</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">JedisException</span><span class="o">(</span><span class="s">"Unknown message type: "</span> <span class="o">+</span> <span class="n">firstObj</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">isSubscribed</span><span class="o">());</span>

    <span class="cm">/* Invalidate instance since this thread is no longer listening */</span>
    <span class="k">this</span><span class="o">.</span><span class="na">client</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>
</code></pre></div></div> <p>一直往源代码内部进入，可以看到阻塞读数据的过程</p> <p><img src="https://blog.maplestory.work/images/post_image/Redis学习（三）.assets/1597732365444.png" alt="1597732365444" /></p> <p><a name="anchor2"><strong>资源池配置:</strong></a></p> <p>RedisPool实例化过程</p> <p><img src="https://blog.maplestory.work/images/post_image/Redis学习（三）.assets/1597732998397.png" alt="1597732998397" /></p> <p>在RedisPool中可以定义资源的参数。默认参数<code class="language-plaintext highlighter-rouge">GenericObjectPoolConfig</code>如下：</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="cm">/**
     * The default value for the {@code maxTotal} configuration attribute.
     * @see GenericObjectPool#getMaxTotal()
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">DEFAULT_MAX_TOTAL</span> <span class="o">=</span> <span class="mi">8</span><span class="o">;</span>

    <span class="cm">/**
     * The default value for the {@code maxIdle} configuration attribute.
     * @see GenericObjectPool#getMaxIdle()
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">DEFAULT_MAX_IDLE</span> <span class="o">=</span> <span class="mi">8</span><span class="o">;</span>

    <span class="cm">/**
     * The default value for the {@code minIdle} configuration attribute.
     * @see GenericObjectPool#getMinIdle()
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">DEFAULT_MIN_IDLE</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</code></pre></div></div> <p>最多能获得八个资源，如果申请了八个资源都没有close的话会导致阻塞。</p> <br> <nav class="pagination"> <a href="http://localhost:4000/%E8%AE%B0%E5%BD%95Markdown%E9%A1%B5%E5%86%85%E8%B7%B3%E8%BD%AC%E6%96%B9%E6%B3%95/" class="pagination_pager" title="记录Markdown页内跳转方法 ">previous</a> <a href="http://localhost:4000/Redis%E5%AD%A6%E4%B9%A0-%E5%9B%9B/" class="pagination_pager" title="Redis学习（四） ">next</a> </nav> </div> </div> <!-- JS --> <script src="http://localhost:4000/assets/js/main.min.js"></script> <div class="overlay"> <ul class="projects-menu"> <li style="background:url(http://localhost:4000/images/benjamin-deyoung-unsplash.jpg) center center no-repeat;"> <a href="https://github.com/Maple-Chan" target="_blank" rel="nofollow external"> <span> GitHub Home </span> </a> </li> <li style="background:url(http://localhost:4000/images/unsplash-image-4.jpg) center center no-repeat;"> <a href="https://blog.maplestory.work/page/classcheckin.html" target="_blank" rel="nofollow external"> <span> 点名小程序 </span> </a> </li> </ul> </div> </body> </html>
