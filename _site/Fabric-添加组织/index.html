<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> <title>Fabric: 添加组织 &#8211; Maple Story</title> <meta name="description" content="Stick to note down what I’v learnt"> <meta name="keywords" content="Hyperledger Fabric"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="halve.png"> <meta name="twitter:title" content="Fabric: 添加组织"> <meta name="twitter:description" content="Stick to note down what I’v learnt"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="Fabric: 添加组织"> <meta property="og:description" content="Stick to note down what I’v learnt"> <meta property="og:url" content="http://localhost:4000/Fabric-%E6%B7%BB%E5%8A%A0%E7%BB%84%E7%BB%87/"> <meta property="og:site_name" content="Maple Story"> <meta property="og:image" content="http://localhost:4000/images/halve.png"> <link rel="canonical" href="http://localhost:4000/Fabric-%E6%B7%BB%E5%8A%A0%E7%BB%84%E7%BB%87/"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Feed --> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="" /> <!-- Favicons --> <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png" /> <link rel="shortcut icon" href="http://localhost:4000/favicon.ico" /> <!-- CSS --> <link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/main.css"> <!-- Left Block Image for Posts --> <style type="text/css"> #posts.inner-post-page .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(http://localhost:4000/images/unsplash-gallery-image-3.jpg) no-repeat;background-size: cover;} </style> <!-- Left Block Images for Home and Pages --> <style type="text/css"> #posts .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(http://localhost:4000/images/unsplash-image-10.jpg) no-repeat;background-size: cover, cover;} .block-left {background: linear-gradient(rgba(44,45,51,0.9), rgba(44,45,51,0.9)), url(http://localhost:4000/images/home.jpg) no-repeat;background-size: cover;} </style> </head> <body id="posts" class="inner-post-page"> <div class="block-left"> <div class="content"> <a href="http://localhost:4000" class="logo"><img src="http://localhost:4000/images/halve.png"></a> <div class="post-title-section"> <div class="section-line">Posts <em>/</em></div> <h1 class="section-title">Fabric: 添加组织 </h1> <ul class="tags"> <li><a href="http://localhost:4000/tags#Hyperledger Fabric">Hyperledger Fabric</a></li> </ul> <div class="section-line reverse"><a href="http://localhost:4000/posts">Back to posts</a> <em>/</em></div> </div> </div> </div> <div class="block-right"> <a href="../posts.html" title="posts" class="posts-menu-icon"></a> <a title="projects" class="projects-menu-icon"> <span></span> </a> <div class="inner-post content"> <div class="date-highlight">06 Jun 2020</div> <center><h2><b>Fabric: 添加组织</b></h2></center> <p><br /></p> <h3 id="概述流程">概述流程</h3> <ol> <li> <p>生成证书</p> </li> <li> <p>编写新组织的configtx.yaml</p> </li> <li> <p>生成，新组织的json文件</p> </li> <li> <p>启动容器</p> </li> <li> <p><strong>获取最新系统配置的pb文件（可能需要tls证书）</strong></p> </li> <li> <p><strong>利用configtxlator将pb转换成json</strong></p> </li> <li> <p>将新组织的json加入到最新区块的json中</p> </li> <li> <p>利用configtxlator将原始的，修改后的json转换成pb文件</p> </li> <li> <p>计算原始pb和新增加组织的pb增量</p> </li> <li> <p>将该增量转换成json，向增量加入如下json。</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s1">'{"payload":{"header":{"channel_header":{"channel_id":"'</span><span class="nv">$CHANNEL</span><span class="s1">'", "type":2}},"data":{"config_update":'</span><span class="si">$(</span><span class="nb">cat </span>config_update.json<span class="si">)</span><span class="s1">'}}}'</span> | jq <span class="nb">.</span> <span class="o">&gt;</span>config_update_in_envelope.json
</code></pre></div> </div> </li> <li> <p>将第10步改好的json转换成pb格式。</p> </li> <li> <p>为这个做好的增量pb签名</p> </li> <li> <p>peer channel update 更新到区块上。</p> </li> <li> <p>在新组织的peer节点加入通道</p> </li> </ol> <h3 id="实验">实验</h3> <blockquote> <p>在1.4版本的first-network例子中实验。成功将新组织加入到mychannel通道</p> </blockquote> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nb">cd </span>org3-artifacts
</code></pre></div></div> <p>生成证书</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>../../bin/cryptogen generate <span class="nt">--config</span><span class="o">=</span>./org3-crypto.yaml
</code></pre></div></div> <p>生成org3的json字符串</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">FABRIC_CFG_PATH</span><span class="o">=</span><span class="nv">$PWD</span> <span class="o">&amp;&amp;</span> ../../bin/configtxgen <span class="nt">-printOrg</span> Org3MSP <span class="o">&gt;</span> ../channel-artifacts/org3.json
</code></pre></div></div> <p>拷贝order证书到org3目录下</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ../ <span class="o">&amp;&amp;</span> <span class="nb">cp</span> <span class="nt">-r</span> crypto-config/ordererOrganizations org3-artifacts/crypto-config/
docker <span class="nb">exec</span> <span class="nt">-it</span> cli bash
<span class="nb">export </span><span class="nv">ORDERER_CA</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem  <span class="o">&amp;&amp;</span> <span class="nb">export </span><span class="nv">CHANNEL_NAME</span><span class="o">=</span>mychannel
</code></pre></div></div> <p>获取mychannel的配置区块</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>peer channel fetch config config_block.pb <span class="nt">-o</span> orderer.example.com:7050 <span class="nt">-c</span> <span class="nv">$CHANNEL_NAME</span> <span class="nt">--tls</span> <span class="nt">--cafile</span> <span class="nv">$ORDERER_CA</span>
</code></pre></div></div> <p>转为json</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>configtxlator proto_decode <span class="nt">--input</span> config_block.pb <span class="nt">--type</span> common.Block | jq .data.data[0].payload.data.config <span class="o">&gt;</span> config.json
</code></pre></div></div> <p>将org3加入到此json中</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jq <span class="nt">-s</span> <span class="s1">'.[0] * {"channel_group":{"groups":{"Application":{"groups": {"Org3MSP":.[1]}}}}}'</span> config.json ./channel-artifacts/org3.json <span class="o">&gt;</span> modified_config.json
</code></pre></div></div> <p>转为pb</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>configtxlator proto_encode <span class="nt">--input</span> config.json <span class="nt">--type</span> common.Config <span class="nt">--output</span> config.pb
</code></pre></div></div> <p>转为pb</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>configtxlator proto_encode <span class="nt">--input</span> modified_config.json <span class="nt">--type</span> common.Config <span class="nt">--output</span> modified_config.pb
</code></pre></div></div> <p>计算pb之间的增量</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>configtxlator compute_update <span class="nt">--channel_id</span> <span class="nv">$CHANNEL_NAME</span> <span class="nt">--original</span> config.pb <span class="nt">--updated</span> modified_config.pb <span class="nt">--output</span> org3_update.pb
</code></pre></div></div> <p>转为json</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>configtxlator proto_decode <span class="nt">--input</span> org3_update.pb <span class="nt">--type</span> common.ConfigUpdate | jq <span class="nb">.</span> <span class="o">&gt;</span> org3_update.json
</code></pre></div></div> <p>加入header信息</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s1">'{"payload":{"header":{"channel_header":{"channel_id":"mychannel", "type":2}},"data":{"config_update":'</span><span class="si">$(</span><span class="nb">cat </span>org3_update.json<span class="si">)</span><span class="s1">'}}}'</span> | jq <span class="nb">.</span> <span class="o">&gt;</span> org3_update_in_envelope.json
</code></pre></div></div> <p>转为pb</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>configtxlator proto_encode <span class="nt">--input</span> org3_update_in_envelope.json <span class="nt">--type</span> common.Envelope <span class="nt">--output</span> org3_update_in_envelope.pb
</code></pre></div></div> <p>org1签名</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>peer channel signconfigtx <span class="nt">-f</span> org3_update_in_envelope.pb
</code></pre></div></div> <p>切换到org2签名</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt
<span class="nb">export </span><span class="nv">CORE_PEER_MSPCONFIGPATH</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp
<span class="nb">export </span><span class="nv">CORE_PEER_ADDRESS</span><span class="o">=</span>peer0.org2.example.com:7051export <span class="nv">CORE_PEER_LOCALMSPID</span><span class="o">=</span><span class="s2">"Org2MSP"</span>
<span class="nb">export </span><span class="nv">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt
<span class="nb">export </span><span class="nv">CORE_PEER_MSPCONFIGPATH</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org2.example.com/users/Admin@org2.example.com/msp
<span class="nb">export </span><span class="nv">CORE_PEER_ADDRESS</span><span class="o">=</span>peer0.org2.example.com:7051
</code></pre></div></div> <p>上传新配置</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>peer channel update <span class="nt">-f</span> org3_update_in_envelope.pb <span class="nt">-c</span> <span class="nv">$CHANNEL_NAME</span> <span class="nt">-o</span> orderer.example.com:7050 <span class="nt">--tls</span> <span class="nt">--cafile</span> <span class="nv">$ORDERER_CA</span>
</code></pre></div></div> <p>编写docker-compose文件</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker-compose <span class="nt">-f</span> docker-compose-org3.yaml up <span class="nt">-d</span>
</code></pre></div></div> <p>进入容器</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker <span class="nb">exec</span> <span class="nt">-it</span> Org3cli bash
<span class="nb">export </span><span class="nv">ORDERER_CA</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem <span class="o">&amp;&amp;</span> <span class="nb">export </span><span class="nv">CHANNEL_NAME</span><span class="o">=</span>mychannel
</code></pre></div></div> <p>获取第0个区块</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>peer channel fetch 0 mychannel.block <span class="nt">-o</span> orderer.example.com:7050 <span class="nt">-c</span> <span class="nv">$CHANNEL_NAME</span> <span class="nt">--tls</span> <span class="nt">--cafile</span> <span class="nv">$ORDERER_CA</span>
</code></pre></div></div> <p>加入到channel里边</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>peer channel <span class="nb">join</span> <span class="nt">-b</span> mychannel.block
</code></pre></div></div> <p>切换到另一peer</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="o">=</span>/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org3.example.com/peers/peer1.org3.example.com/tls/ca.crt <span class="o">&amp;&amp;</span> <span class="nb">export </span><span class="nv">CORE_PEER_ADDRESS</span><span class="o">=</span>peer1.org3.example.com:7051
</code></pre></div></div> <p>加入到channel里边</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>peer channel <span class="nb">join</span> <span class="nt">-b</span> mychannel.block
</code></pre></div></div> <hr /> <p>配置锚节点（可选）</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>peer channel fetch config config_block.pb <span class="nt">-o</span> orderer.example.com:7050 <span class="nt">-c</span> mychannel <span class="nt">--tls</span> <span class="nt">--cafile</span> <span class="nv">$ORDERER_CA</span>

configtxlator proto_decode <span class="nt">--input</span> config_block.pb <span class="nt">--type</span> common.Block | jq .data.data[0].payload.data.config <span class="o">&gt;</span> config.json

jq <span class="s1">'.channel_group.groups.Application.groups.Org3MSP.values += {"AnchorPeers":{"mod_policy": "Admins","value":{"anchor_peers": [{"host": "peer0.org3.example.com","port": 11051}]},"version": "0"}}'</span> config.json <span class="o">&gt;</span> modified_anchor_config.json

configtxlator proto_encode <span class="nt">--input</span> config.json <span class="nt">--type</span> common.Config <span class="nt">--output</span> config.pb

configtxlator proto_encode <span class="nt">--input</span> modified_anchor_config.json <span class="nt">--type</span> common.Config <span class="nt">--output</span> modified_anchor_config.pb

configtxlator compute_update <span class="nt">--channel_id</span> <span class="nv">$CHANNEL_NAME</span> <span class="nt">--original</span> config.pb <span class="nt">--updated</span> modified_anchor_config.pb <span class="nt">--output</span> anchor_update.pb

configtxlator proto_decode <span class="nt">--input</span> anchor_update.pb <span class="nt">--type</span> common.ConfigUpdate | jq <span class="nb">.</span> <span class="o">&gt;</span> anchor_update.json

<span class="nb">echo</span> <span class="s1">'{"payload":{"header":{"channel_header":{"channel_id":"mychannel", "type":2}},"data":{"config_update":'</span><span class="si">$(</span><span class="nb">cat </span>anchor_update.json<span class="si">)</span><span class="s1">'}}}'</span> | jq <span class="nb">.</span> <span class="o">&gt;</span> anchor_update_in_envelope.json

configtxlator proto_encode <span class="nt">--input</span> anchor_update_in_envelope.json <span class="nt">--type</span> common.Envelope <span class="nt">--output</span> anchor_update_in_envelope.pb

peer channel update <span class="nt">-f</span> anchor_update_in_envelope.pb <span class="nt">-c</span> mychannel <span class="nt">-o</span> orderer.example.com:7050 <span class="nt">--tls</span> <span class="nt">--cafile</span> <span class="nv">$ORDERER_CA</span>


</code></pre></div></div> <br> <nav class="pagination"> <a href="http://localhost:4000/Fabric-MSP%E7%AE%A1%E7%90%86%E5%91%98%E7%9A%84%E6%94%B9%E5%8A%A8/" class="pagination_pager" title="Fabric: MSP管理员的改动 ">previous</a> <a href="http://localhost:4000/No-Such-Provider/" class="pagination_pager" title="No Such Provider ">next</a> </nav> </div> </div> <!-- JS --> <script src="http://localhost:4000/assets/js/main.min.js"></script> <div class="overlay"> <ul class="projects-menu"> <li style="background:url(http://localhost:4000/images/unsplash-image-4.jpg) center center no-repeat;"> <a href="https://blog.maplestory.work/classcheckin.html" target="_blank" rel="nofollow external"> <span> 点名小程序 </span> </a> </li> </ul> </div> </body> </html>
