<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> <title>Java调用Shell &#8211; Maple Story</title> <meta name="description" content="Stick to note down what I’v learnt"> <meta name="keywords" content="Java"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="halve.png"> <meta name="twitter:title" content="Java调用Shell"> <meta name="twitter:description" content="Stick to note down what I’v learnt"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="Java调用Shell"> <meta property="og:description" content="Stick to note down what I’v learnt"> <meta property="og:url" content="http://localhost:4000/Java%E8%B0%83%E7%94%A8Shell/"> <meta property="og:site_name" content="Maple Story"> <meta property="og:image" content="http://localhost:4000/images/halve.png"> <link rel="canonical" href="http://localhost:4000/Java%E8%B0%83%E7%94%A8Shell/"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Feed --> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="" /> <!-- Favicons --> <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png" /> <link rel="shortcut icon" href="http://localhost:4000/favicon.ico" /> <!-- CSS --> <link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/main.css"> <!-- Left Block Image for Posts --> <style type="text/css"> #posts.inner-post-page .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(http://localhost:4000/images/unsplash-gallery-image-3.jpg) no-repeat;background-size: cover;} </style> <!-- Left Block Images for Home and Pages --> <style type="text/css"> #posts .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(http://localhost:4000/images/unsplash-image-10.jpg) no-repeat;background-size: cover, cover;} .block-left {background: linear-gradient(rgba(44,45,51,0.9), rgba(44,45,51,0.9)), url(http://localhost:4000/images/home.jpg) no-repeat;background-size: cover;} </style> </head> <body id="posts" class="inner-post-page"> <div class="block-left"> <div class="content"> <a href="http://localhost:4000" class="logo"><img src="http://localhost:4000/images/halve.png"></a> <div class="post-title-section"> <div class="section-line">Posts <em>/</em></div> <h1 class="section-title">Java调用Shell </h1> <ul class="tags"> <li><a href="http://localhost:4000/tags#Java">Java</a></li> </ul> <div class="section-line reverse"><a href="http://localhost:4000/posts">Back to posts</a> <em>/</em></div> </div> </div> </div> <div class="block-right"> <a href="../posts.html" title="posts" class="posts-menu-icon"></a> <a title="projects" class="projects-menu-icon"> <span></span> </a> <div class="inner-post content"> <div class="date-highlight">05 Aug 2020</div> <center><h2><b>Java调用Shell</b></h2></center> <p><br /></p> <p>ProcessBuilder类是J2SE 1.5在java.lang中新添加的一个新类，此类用于创建操作系统进程，它提供一种启动和管理进程（也就是应用程序）的方法。在J2SE 1.5之前，都是由Process类处理实现进程的控制管理。<strong>每个 ProcessBuilder 实例管理一个进程属性集。它的start() 方法利用这些属性创建一个新的 Process 实例。start() 方法可以从同一实例重复调用，以利用相同的或相关的属性创建新的子进程。</strong></p> <p>ProcessBuilder.start() 和 Runtime.exec() 方法都被用来创建一个操作系统<strong>进程</strong>（执行命令行操作），并返回 Process 子类的一个实例，该实例可用来控制进程状态并获得相关信息。 ProcessBuilder.start() 和 Runtime.exec()传递的参数有所不同，Runtime.exec()可接受一个单独的字符串，这个字符串是通过空格来分隔可执行命令程序和参数的；也可以接受字符串数组参数。而ProcessBuilder的构造函数是一个字符串列表或者数组。列表中第一个参数是可执行命令程序，其他的是命令行执行是需要的参数。</p> <h3 id="1-调用正常脚本二进制命令">1. 调用正常脚本/二进制命令</h3> <p>封装如下类，进行调用shell命令。</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CallShellUtil</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">CallShellUtil</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">runCommand</span><span class="o">(</span><span class="nc">File</span> <span class="n">workDirector</span><span class="o">,</span> <span class="nc">String</span><span class="o">...</span> <span class="n">cmd</span><span class="o">)</span> <span class="kd">throws</span>  <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">ProcessBuilder</span> <span class="n">processBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProcessBuilder</span><span class="o">(</span><span class="n">cmd</span><span class="o">);</span>
        <span class="n">processBuilder</span><span class="o">.</span><span class="na">directory</span><span class="o">(</span><span class="n">workDirector</span><span class="o">);</span>

        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"processBuilder.environment:"</span><span class="o">);</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"env:{}"</span><span class="o">,</span> <span class="n">processBuilder</span><span class="o">.</span><span class="na">environment</span><span class="o">());</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"工作目录 pwd:{}"</span><span class="o">,</span> <span class="n">processBuilder</span><span class="o">.</span><span class="na">directory</span><span class="o">());</span>

        <span class="nc">String</span> <span class="n">resultString</span><span class="o">;</span>

        <span class="c1">//返回值，0为正确执行</span>
        <span class="kt">int</span> <span class="n">runningStatus</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>

        <span class="nc">Process</span> <span class="n">shellProcess</span> <span class="o">=</span> <span class="n">processBuilder</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="nc">BufferedReader</span> <span class="n">stdInput</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="n">shellProcess</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">()));</span>
        <span class="nc">BufferedReader</span> <span class="n">stdError</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="n">shellProcess</span><span class="o">.</span><span class="na">getErrorStream</span><span class="o">()));</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">//等待命令执行</span>
            <span class="n">runningStatus</span> <span class="o">=</span> <span class="n">shellProcess</span><span class="o">.</span><span class="na">waitFor</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="cm">/*显示日志*/</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="o">(</span><span class="n">resultString</span> <span class="o">=</span> <span class="n">stdError</span><span class="o">.</span><span class="na">readLine</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">resultString</span><span class="o">);</span> <span class="c1">//问题，fabric的info输出，这里需要getErrorStream获取到</span>
        <span class="o">}</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="o">(</span><span class="n">resultString</span> <span class="o">=</span> <span class="n">stdInput</span><span class="o">.</span><span class="na">readLine</span><span class="o">()))</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">resultString</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"running status:{}"</span><span class="o">,</span> <span class="n">runningStatus</span><span class="o">);</span>
        <span class="c1">//销毁进程</span>
        <span class="n">shellProcess</span><span class="o">.</span><span class="na">destroy</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">runningStatus</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div> <p>调用方法</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">new</span> <span class="nc">CallShellUtil</span><span class="o">().</span><span class="na">runCommand</span><span class="o">(</span>
    <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="s">"workspace"</span><span class="o">),</span>
    <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="s">"command"</span><span class="o">,</span><span class="s">"arg1"</span><span class="o">,</span><span class="s">"arg2"</span><span class="o">});</span>
</code></pre></div></div> <h3 id="2-调用带有--与--命令">2. 调用带有 <code class="language-plaintext highlighter-rouge">&gt;</code> 与 <code class="language-plaintext highlighter-rouge">|</code> 命令</h3> <blockquote> <p>参考：<a href="https://www.cnblogs.com/lisperl/archive/2012/06/28/2568494.html">https://www.cnblogs.com/lisperl/archive/2012/06/28/2568494.html</a></p> </blockquote> <blockquote> <p>背景：在Fabric-sdk-java的一个应用中，我们需要用到Linux下的configtxgen工具来从configtx.yaml文件转换成一个json文件。</p> </blockquote> <p>命令如下</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./configtxgen <span class="nt">-printOrg</span> Msp-org2 <span class="o">&gt;</span> org3.json
</code></pre></div></div> <p>按照1.中的方式将命令传入ProcessBuilder，不能正确执行，无法重定向生成org3.json。</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="no">CONFIGTXGEN</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"user.dir"</span><span class="o">)</span> <span class="o">+</span> <span class="s">"/files/configtxgen"</span><span class="o">;</span>
<span class="nc">String</span><span class="o">[]</span> <span class="n">cmd</span> <span class="o">=</span> <span class="o">{</span>    <span class="no">CONFIGTXGEN</span><span class="o">,</span>
                    <span class="s">"-printOrg"</span><span class="o">,</span>
                    <span class="n">orgName</span><span class="o">,</span>
                    <span class="s">"&gt;"</span><span class="o">,</span>
                    <span class="n">path</span>
               <span class="o">}</span>
<span class="nc">ProcessBuilder</span> <span class="n">processBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProcessBuilder</span><span class="o">(</span><span class="n">cmd</span><span class="o">);</span>
</code></pre></div></div> <p>原因是，ProcessBuilder无法识别重定向符号“&gt;”。</p> <h4 id="尝试1">尝试1</h4> <p>用如下替代：</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="no">CONFIGTXGEN</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"user.dir"</span><span class="o">)</span> <span class="o">+</span> <span class="s">"/files/configtxgen"</span><span class="o">;</span>
<span class="nc">String</span><span class="o">[]</span> <span class="n">cmd</span> <span class="o">=</span> <span class="o">{</span> <span class="s">"sh"</span><span class="o">,</span>
                <span class="s">"-c"</span><span class="o">,</span>
                <span class="s">"\'"</span><span class="o">+</span> <span class="no">CONFIGTXGEN</span> <span class="o">+</span> <span class="s">" -printOrg "</span> <span class="o">+</span> <span class="n">orgName</span> <span class="o">+</span> <span class="s">" &gt; "</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s">"\'"</span>
               <span class="o">}</span>
<span class="c1">// 第一反应这么写的原因，可以用sh -c './configtxgen -printOrg MSP-org2 &gt; org2.json' 来生成命令</span>
</code></pre></div></div> <p>替换后，报sh: connot find file or directory错误。</p> <p>据分析原因，传入ProcessBuilder之后，将第三个参数作为一个字符串进行执行了。</p> <h4 id="经过调整">经过调整</h4> <p>将命令作为如下数组传入：</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="no">CONFIGTXGEN</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"user.dir"</span><span class="o">)</span> <span class="o">+</span> <span class="s">"/files/configtxgen"</span><span class="o">;</span>
<span class="nc">String</span><span class="o">[]</span> <span class="n">cmd</span> <span class="o">=</span> <span class="o">{</span> <span class="s">"sh"</span><span class="o">,</span>
                <span class="s">"-c"</span><span class="o">,</span>
                <span class="s">""</span><span class="o">+</span> <span class="no">CONFIGTXGEN</span> <span class="o">+</span> <span class="s">" -printOrg "</span> <span class="o">+</span> <span class="n">orgName</span> <span class="o">+</span> <span class="s">" &gt; "</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s">""</span>
               <span class="o">}</span>
</code></pre></div></div> <h4 id="其他解决思路">其他解决思路</h4> <p>我们也可以通过仅执行<code class="language-plaintext highlighter-rouge">./configtxgen -printOrg Msp-org2</code>,然后对输出进行处理，生成org.json文件在Java中使用、保存。</p> <br> <nav class="pagination"> <a href="http://localhost:4000/Spring%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95-%E4%B8%8A%E4%B8%8B%E6%96%87/" class="pagination_pager" title="加载Spring上下文用以测试 ">previous</a> <a href="http://localhost:4000/Java%E7%BA%BF%E7%A8%8B%E4%B8%8D%E8%83%BD%E9%87%8D%E5%A4%8DStart/" class="pagination_pager" title="Java线程为什么不能重复调用start() ">next</a> </nav> </div> </div> <!-- JS --> <script src="http://localhost:4000/assets/js/main.min.js"></script> <div class="overlay"> <ul class="projects-menu"> <li style="background:url(http://localhost:4000/images/benjamin-deyoung-unsplash.jpg) center center no-repeat;"> <a href="https://github.com/Maple-Chan" target="_blank" rel="nofollow external"> <span> GitHub Home </span> </a> </li> <li style="background:url(http://localhost:4000/images/unsplash-image-4.jpg) center center no-repeat;"> <a href="https://blog.maplestory.work/page/app/randomCheckIn" target="_blank" rel="nofollow external"> <span> 点名小程序 </span> </a> </li> </ul> </div> </body> </html>
